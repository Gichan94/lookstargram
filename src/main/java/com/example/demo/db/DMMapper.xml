<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 <mapper namespace="dm">

	<!-- 메세지 list에서 상대방 profile 가져오기 -->
	<select id="getProfile" parameterType="DMVO" resultType="String">
	    SELECT users_fname FROM users
	    <choose>
	        <when test="from_nickname == my_nickname">
	            where my_nickname = #{to_nickname}
	        </when>
	        <otherwise>
	            where my_nickname = #{from_nickname}
	        </otherwise>
	    </choose>
	</select>


 	<!-- 메세지 리스트 가져오기 -->
	<select id="dmList" parameterType="DMVO" resultType="DMVO">
	    SELECT dm_no, room_no, from_nickname, to_nickname, send_time, read_time, dm_content, read_chk
	    FROM dm
	    WHERE dm_no in(SELECT MAX(dm_no) from dm GROUP BY room_no)
	    AND (from_nickname=#{my_nickname} or to_nickname=#{my_nickname})
	    order by dm_no desc
	</select>

	
	<!-- 메세지 내용 가져오기 -->
	<select id="getContentList" parameterType="DMVO" resultType="DMVO">
	   SELECT dm_no, room_no, from_nickname, to_nickname, send_time, read_time, dm_content, read_chk, users_fname
	   FROM dm LEFT OUTER JOIN users u
	   ON from_nickname = users_nickname
	    <choose>
	        <when test="room_no != 0">
	            WHERE room_no=#{room_no}
	        </when>
	        <otherwise>
	            WHERE (from_nickname=#{my_nickname} AND to_nickname=#{to_nickname}) 
	            OR (from_nickname=#{to_nickname} AND to_nickname=#{my_nickname})
	        </otherwise>
	    </choose>	
	</select>


	<!-- 메세지 읽음 처리  -> read_chk -->
	<update id="readDM" parameterType="DMVO">
	    UPDATE DM SET read_chk=1
	    <choose>
	        <when test="room_no != 0">
	            WHERE room_no=#{room_no} AND read_chk=0 AND to_nickname=#{my_nickname}
	        </when>
	        <otherwise>
	            where from_nickname=#{to_nickname} AND read_chk=0 AND to_nickname=#{my_nickname}
	        </otherwise>
	    </choose>	
	</update>

	
	<!-- 안읽은 메세지 갯수 가져오기 -> read_chk -->
	<select id="notReadDM" parameterType="DMVO">
	    SELECT count(dm_no) oldDM
	    FROM dm 
	    WHERE to_nickname=#{my_nickname} and read_chk=0 and room_no=#{room_no}
	</select>
	
		
	<!-- 메세지리스트에서 메세지 보내기 -->
	<insert id="insertDM" parameterType="DMVO">
		INSERT INTO dm VALUES(seq_dm.nextval, #{room_no}, #{from_nickname}, #{to_nickname}, SYSDATE, SYSDATE, #{dm_content}, 0)	      
	</insert>
	
	
	<!-- room 번호 최댓값 구하기 -->
	<select id="findMaxRoomNumber"  parameterType="DMVO" resultType="int">
	    SELECT max(room_no) FROM dm
	</select>
	
	 
	<!-- 메세지 이력이 있는지 검색 -->
	<select id="findOldDM" parameterType="DMVO" resultType="int">
	    SELECT count(dm_no) oldDM 
	    FROM dm 
	    WHERE (from_nickname=#{from_nickname} AND to_nickname = #{to_nickname}) 
	    OR (from_nickname = #{to_nickname} AND to_nickname=#{from_nickname})
	</select>
	
	
	<!-- 기존 메세지 내역의 room 번호를 가져옴 -->
	<select id="findRoomNumber"  parameterType="DMVO" resultType="String">
	    SELECT room_no
	    FROM dm
	    WHERE (from_nickname=#{from_nickname} AND to_nickname = #{to_nickname}) 
	    OR (from_nickname = #{to_nickname} AND to_nickname=#{from_nickname})
	    AND room_no IN(0,1)	
	 </select>
 </mapper>